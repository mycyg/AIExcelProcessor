
# Excel 批量处理工具

这是一个使用 PySide6 构建的桌面应用程序，可以通过调用大语言模型（LLM）的API来批量处理 Excel 文件中的数据。
> 直接代码复制吧。临时更新了点儿，增加了异步处理模式 //仅支持火山SDK，适用于成吨数据的处理，调用的火山批量推理的接入点（不是常规接入点！）

# 更新日志

## 2025-08-25

### ✨ 新功能 (New Features)

- **新增“一键配置所有模板”功能**
  - 在“第四步：提示词设置”区域，新增了一个强大的“一键配置所有模板”按钮。
  - 用户只需设置好输入文件、勾选输入列、并定义输出列，点击此按钮即可利用LLM自动分析数据结构，并一次性生成“内容整合模板”和“LLM提示词模板”的内容。
  - 此功能旨在最大程度地减少手动配置模板的复杂性，实现从原始数据到完整配置的一键化操作。

### 🐛 Bug修复 (Bug Fixes)

- **修复了“标准模式”下因行数计算错误导致处理失败的问题**：重构了标准模式的数据读取逻辑，使其与SDK模式同样健壮，解决了在处理某些Excel文件时行数被错误识别为0的问题。
- **修正了“开始处理”过程中的日志打印错误**：现在，`--- 提交给 LLM 的内容 ---` 日志会准确显示发送给LLM的完整、最终的提示词，而不再是中间生成的部分内容。
- **修正了API调用中的payload格式问题**：调整了API请求的数据结构，以兼容需要特定多模态格式的API端点，解决了`403 Forbidden`权限错误。


## 功能

- **灵活配置**: 通过图形化界面轻松配置输入/输出文件、API信息、要处理的列等。
- **模板化处理**: 使用自定义模板来整合输入列的内容，并构建发送给LLM的最终提示词。
- **批量与并行**: 支持配置批处理大小和并行工作线程数，以平衡处理速度和API调用频率。
- **健壮性**: 处理大数据时使用临时文件以节省内存，并有清晰的日志记录处理过程。

## 环境要求

- Python 3.8 或更高版本

## 安装与运行

我们强烈建议在Python虚拟环境中运行此应用，以避免与系统中的其他Python库产生冲突。

1.  **创建虚拟环境** (在 `ExcelProcessor` 目录下打开终端):
    ```bash
    python -m venv venv
    ```

2.  **激活虚拟环境**:
    -   Windows:
        ```bash
        .\venv\Scripts\activate
        ```
    -   macOS / Linux:
        ```bash
        source venv/bin/activate
        ```

3.  **安装依赖库**:
    ```bash
    pip install -r requirements.txt
    ```

4.  **运行应用**:
    ```bash
    python qt_app.py
    ```

## 配置

- 首次运行或保存设置后，所有配置项将保存在 `config.json` 文件中。
- **API URL**: 例如，`https://ark.cn-beijing.volces.com/api/v3/chat/completions`
- **API Key**: 请确保在图形界面的“API设置”中填入你自己的有效API Key。
- **模板语法**:
    -   **内容整合模板**: 使用 `{row['列名']}` 的格式来引用输入Excel文件中的列。
    -   **LLM提示词模板**: 使用 `{{content}}` 来引用由“内容整合模板”生成的内容。

---

# 项目更新说明 (Project Update Notes)

## 概述

旧代码存在严重的设计问题，包括技术栈混乱、代码高度耦合、缺乏健壮性等。当前版本在一个全新的、稳定的、可维护的架构基础上，完整复现并增强了原有功能。

---

## 核心改进

### 1. 架构重构 (Architectural Refactoring)

这是本次更新最核心的改动。我们废弃了之前那种UI、逻辑、数据混成一坨的“意大利面条”代码，引入了清晰的架构分层：

-   **`config.py`**: 定义了所有配置和状态的数据模型。是整个应用的“单一事实来源”。
-   **`processor.py`**: 封装了所有后端业务逻辑（读写Excel、调用API、数据处理）。它完全独立于UI，可以被任何界面（图形或命令行）调用。
-   **`qt_app.py`**: 只负责UI的展示和用户交互。它通过信号和槽与后端逻辑安全地通信。

这种分离使得代码更容易理解、维护和扩展。

### 2. UI/UX 改进 (UI/UX Improvements)

-   **统一技术栈**: 彻底移除了冗余的 `tkinter` 代码，项目现在完全使用 `PySide6` 构建，结束了技术栈混乱的状态。
-   **布局迭代**: UI布局经过了多次迭代，最终实现了以“提示词编辑”为核心、其他设置为辅助的专业布局。
-   **滚动条**: 为“输入列”这种可能出现长列表的区域增加了独立的滚动条，避免了因内容过多导致整个窗口被撑坏的问题。
-   **悬浮提示 (Tooltips)**: 为所有关键的设置项（包括文本标签）都增加了清晰的悬浮提示，极大地增强了界面的自解释性，降低了新用户的学习成本。

### 3. 功能增强与修复 (Functional Enhancements & Fixes)

-   **API调用重试**: API调用现在包含最多3次的自动重试机制，能有效应对网络波动，极大提高了批量处理的成功率。
-   **健壮的JSON解析**: 通过在提示词中加入强制指令，要求LLM返回严格的JSON格式。解析器也会从返回文本中精准提取JSON部分，不再受LLM返回的额外文本（如 ` ```json `）的干扰。
-   **内存优化**: 后端处理逻辑采用临时文件来保存每个批次的结果，最后再合并。这极大降低了处理大文件时的内存消耗，使工具能胜任更繁重的任务。
-   **Bug修复**: 修复了包括“无法选择文件”、“建议窗口闪退”在内的所有在迭代过程中发现的bug。

### 4. 废弃内容 (Deprecations)

-   **`gui` 目录**: 其中所有的 `tkinter` 代码都已被删除。


---

